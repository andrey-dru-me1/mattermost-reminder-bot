# Mattermost Bot Reminder

Этот файл также доступен на других языках: [English](./README.md)

## Содержание

- [Mattermost Bot Reminder](#mattermost-bot-reminder)
  - [Содержание](#содержание)
  - [Описание](#описание)
  - [Требования](#требования)
  - [Установка](#установка)
    - [Тест](#тест)
    - [Релиз](#релиз)
      - [Dockerhub](#dockerhub)
      - [Сборка из исходных файлов](#сборка-из-исходных-файлов)
  - [Использование](#использование)
    - [Cron правило](#cron-правило)
    - [Местоположение](#местоположение)
    - [Webhook](#webhook)
    - [Примеры](#примеры)
  - [Конфигурация](#конфигурация)
    - [.env файл](#env-файл)
    - [Описание контейнеров](#описание-контейнеров)
  - [Миграции](#миграции)

## Описание

Reminder Bot - бот для мессенджера Mattermost, который позволяет создавать как регулярные, так и единовременные уведомления в каналы Mattermost. Бот имеет гибкую настройку регулярности напоминаний, возможность отправки сообщений в приватные каналы и настройку часовых поясов для каналов. Сообщения могут использоваться для напоминания о встречах и важных созвонах, в них можно указывать ссылки на необходимые ресурсы.

## Требования

- go
- golang-migrate (см. [Миграции](#миграции))
- docker
- docker-compose

## Установка

### Тест

1. (Опционально) Выполните команду `docker-compose up test_mm -d`
   1. Команда поднимает локальный сервер мессенджера Mattermost. Можете не выполнять этот пункт, если у вас уже запущен Mattermost, в котором вы являетесь администратором
   2. Если вы решите запустить Mattermost таким образом, то вы сможете зайти в него либо через браузер по адресу <http://localhost:8065>, либо из установленного приложения, добавив новый сервер с тем же URL
2. Добавьте слеш-команду, следуя [официальной инструкции](https://developers.mattermost.com/integrate/slash-commands/custom/). В качестве URL используйте `http://<host>:8080/mattermost/reminders` с методом POST (для локального сервера Mattermost из пункта 1 вместо `<host>` подставьте `reminder`)
   1. Краткая инструкция по добавлению слеш-команды:
      1. Кликните по квадратикам в левом верхнем углу приложения Mattermost, затем `Integrations > Slash Commands > Add Slash Command`
      2. Заполните поля `Command Trigger Word` (`reminder`) и `Request URL` (значение см. выше), опционально заполните остальное и кликните `Save`
      3. Скопируйте токен и нажмите `Done`
   2. Возможно вам придётся разрешить мессенджеру использовать `<host>` для своих запросов. Чтобы это сделать, перейдите в `System Console/Environment/Developer` и добавьте ваш `<host>` в поле `Allow untrusted internal connections to`
3. Создайте `.env` файл в корне репозитория и скопируйте в него содержимое `.env.example` файла. Заполните необходимую информацию (если название переменной окружения вызывает вопросы, посетите раздел [.env файл](#env-файл))
4. Запустите `docker-compose up -d`

### Релиз

#### Dockerhub

Вы можете использовать собранный [образ reminder из регистра dockerhub](https://hub.docker.com/repository/docker/andreydrumel/mm-remind-bot/general). Для этого ваш `docker-compose.yaml`/`Dockerfile` должен выглядеть следующим образом:

```yaml
# docker-compose.yaml
services:
   reminder:
      image: andreydrumel/mm-remind-bot:1.1.2
      ...
```

```Dockerfile
# Dockerfile
FROM andreydrumel/mm-remind-bot:1.1.2
...
```

Не забудьте поменять все необходимые переменные окружения. Информацию об использовании сервисами таких переменных см. в разделе [Описание контейнеров](#описание-контейнеров).

Сервис `poller` не собран в образ на dockerhub. Вы можете написать этот сервис самостоятельно, использовать low-code решение (например n8n) или [собрать докер-образ вручную из исходных файлов](#сборка-из-исходных-файлов).

#### Сборка из исходных файлов

В корневых директориях `poller` и `reminder` содержатся файлы `Dockerfile`. Вы можете собрать докер-образ выполнив в этих директориях команду `docker build .`.

Кроме того, вы можете указать эти директории напрямую в вашем `docker-compose.yaml` файле. Пример можете увидеть в файле корневой директории `docker-compose.prod.yaml`. Используйте этот файл как шаблон для вашего собственного.

## Использование

`/reminder КОМАНДА ОПЦИИ`

Команды:

- `help,h [cron,location,webhook]` - показывает подробное сообщение о выбранной команде
- `add,create НАЗВАНИЕ_НАПОМИНАНИЯ CRON_ПРАВИЛО СООБЩЕНИЕ` - создаёт новое напоминание, которое будет отсылать `СООБЩЕНИЕ` в текущий канал. Периодичность задаётся через `CRON_ПРАВИЛО` (подробнее про синтаксис правила см. [Cron правило](#cron-правило))
- `list,ls` - показывает информацию по напоминаниям, активным в текущем канале
- `delete,del,remove,rm ID...` - удаляет напоминания с `ID` идентификаторами (их можно найти через команду `list` )
- `timezone,tz МЕСТОПОЛОЖЕНИЕ` - обновляет часовой пояс текущего канала (см. [Местоположение](#местоположение))
- `timezone,tz` - показывает действительное для текущего канала местоположение
- `wh,webhook WEBHOOK` - привязывает `WEBHOOK` к пользователю. После выполнения команды, бот сможет отправлять созданные пользователем напоминания везде, куда может отправлять сообщения сам пользователь (см. [Webhook](#webhook))
- `chown,own,steal,snatch ID` - меняет владельца напоминания с указанным `ID` . После выполнения этой команды, при отправлении напоминания будет использоваться webhook нового пользователя (см. [Webhook](#webhook))

### Cron правило

Cron-правило - это строка, с помощью которой можно задавать, когда напоминание будет отправлено. Оно может быть написано тремя способами:

- `Секунда Минута Час ДеньМесяца Месяц ДеньНедели Год`
- `Минута Час ДеньМесяца Месяц ДеньНедели Год` (`Секунда`  приравнивается к нулю)
- `Минута Час ДеньМесяца Месяц ДеньНедели` (`Год`  приравнивается к `*` )

Ниже перечислены конструкции написания cron-правил:

- `Месяц`  можно задать как числом, так и трёхбуквенным обозначением: `1-12` or `JAN-DEC`
- `ДеньНедели`  можно задать как числом, так и трёхбуквенным обозначением: `0-7` or `SUN-SAT` (как `0`, так и `7` отвечают за `SUN`)
- `*` - любое допустимое значение (`0 12 ** *` - 12:00 каждого дня каждого месяца каждого года)
- `/` - временной период (`*/5* ** *` - каждые 5 минут каждого дня каждого месяца каждого года)
- `,` - разделитель списка значений (`0 12 10,25 * *` - 12:00 каждого 10-го и 25-го дней каждого месяца)
- `-` - диапазон значений (`0 12 * MON-FRI *` - 12:00 каждый будний день)
- `L` - last - последний (`0 12 * 5L *` - 12:00 в последнюю пятницу каждого месяца)
- `#` - порядковый номер (`0 12 * TUE#2 *` - 12:00 во второй вторник каждого месяца)

### Местоположение

Местоположение - это идентификатор временной зоны (например: `Asia/Novosibirsk`)

Все местоположения (идентификаторы временной зоны) могут быть найдены [здесь](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones).

### Webhook

Вебхук - точка доступа к Mattermost’у: через неё Reminder bot шлёт сообщения-напоминания в каналы мессенджера. Вебхук имеет те же права доступа, что и создавший его пользователь. В Mattermost’е пользователи могут создавать приватные каналы, к которым доступ будет иметь ограниченный набор лиц. В связи с этим, прежде, чем создать свою напоминалку, необходимо создать и привязать к аккаунту собственный вебхук.

Чтобы создать вебхук и передать его боту, выполните следующие шаги:

1. Кликните на девять квадратиков в левом верхнем углу клиента Mattermost’а, затем выберите `Integrations`
2. Кликните на `Incoming Webhooks`
3. Нажмите на кнопку `Add Incoming Webhook`
4. Выберите название (title) и канал (channel). При создании вебхука необходимо задать канал, куда бот будет слать сообщения по умолчанию, однако, если всё работает правильно, сообщения будут отправляться в тот канал, в котором создавалась напоминалка, и канал по умолчанию работать не будет.
5. Сохраните вебхук и скопируйте URL со следующего экрана. Вебхук должен выглядеть примерно так: `http://<mm_host>/hooks/XXXXXX`
6. Перейдите в любой чат и наберите /reminder webhook `/reminder webhook http://<mm_host>/hooks/XXXXXX` (вместо последнего аргумента вставьте скопированный URL)
7. Готово! По выполнении этих действий бот сможет слать сообщения в любой канал, в который можете вы.

Если пользователь, создавший напоминалку потеряет доступ к чату, вы можете “украсть” владение этой напоминалкой через команду `/reminder steal ID`. После выполнения команды, бот будет использовать ваш вебхук (который вы должны заранее передать боту, следуя гайду выше) для напоминалки с идентификатором `ID` при отправке сообщений.

### Примеры

Команда создаст еженедельное напоминание, которое будет отсылать сообщение в текущий канал каждую пятницу в 12:00

```text
/reminder add "Weekly Reminder" "0 0 12 * * FRI *" "Another week is coming to an end!"
```

---

Команда создаст напоминание, которое будет отсылать сообщение в текущий канал каждый понедельник и четверг в 9:00, 12:00, 15:00 и 18:00

```text
/reminder add "Repeatedly reminder" "0 9-18/3 * * MON,THU"
```

## Конфигурация

База данных: MySQL

### .env файл

- `MYSQL_USER`
- `MYSQL_PASSWORD`
- `DB_HOST` - DataBase Host - хост для доступа к базе данных, по умолчанию используется `db` сервис
- `DB_PORT` - DataBase Port - порт mysql по умолчанию - `3306` - но вы можете поменять его здесь
- `DB_NAME` - DataBase Name - `reminders` по умаолчанию, но вы можете изменить название базы данных исходя из ваших нужд
- `MM_SC_TOKEN` - MatterMost Slash Command Token - токен, которые вы получаете по выполнении [создания слеш-команды](https://developers.mattermost.com/integrate/slash-commands/custom/)

### Описание контейнеров

1. `db` - база данных mysql
   1. `MYSQL_USER`
   2. `MYSQL_PASSWORD`
   3. `MYSQL_DATABASE` == `DB_NAME`
2. `reminder` - сервер с основной логикой бота, который обрабатывает слеш-команды из Mattermost, предоставляет полезные API-эндпоинты для работы с напоминалками, а также выполняет миграции базы данных
   1. `MYSQL_USER`
   2. `MYSQL_PASSWORD`
   3. `DB_HOST`
   4. `DB_PORT`
   5. `DB_NAME`
   6. `MM_SC_TOKEN` - с помощью этого токена осуществляется авторизация клиента Mattermost
   7. `DEFAULT_TZ` - Default Time Zone - часовой пояс по умолчанию
   8. `MIGRATIONS_PATH` - путь до директории, в которой располагаются миграции
3. `poller` - простой сервис, который периодически опрашивает `reminder`-сервис на предмет новых напоминаний, а затем шлёт их в соответствующие каналы Mattermost через webhook
   1. `POLL_PERIOD` - указывает период для опроса `poller`-сервисом `reminder`-сервиса. Задаётся с использованием суффиксов (`2h45m` значит 2 часа 45 минут)
4. `test_mm` в тестовом профиле - контейнер, который содержит локальный Mattermost для тестирования

## Миграции

Миграции выполняются с использованием [этого](https://github.com/golang-migrate/migrate) инструмента.

Для его установки выполните:

```bash
go install -tags 'mysql' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
```

(Эта команда установит консольную программу `migrate` по пути `$HOME/go/bin`. Возможно вам придётся добавить эту переменную в `$PATH`)

---

Создание миграции:

```bash
migrate create -ext sql -dir migrations -seq MIGRATION_NAME
```

---

Имейте ввиду, что миграции запускаются автоматически при запуске контейнера reminder, так что вам нет необходимости выполнять их вручную, если не возникают ошибки.

Выполнение миграции вручную:

```bash
migrate -database 'mysql://MYSQL_USER:MYSQL_PASSWORD@tcp(HOST:PORT)/NAME' -source file://migrations up
```

Все значения выше, указанные верхним регистром, вы задаёте в `.env` файле. При использовании `.env.example` вы получите:

```bash
migrate -database 'mysql://reminders:XXXXXX@tcp(db:3306)/reminders' -source file://migrations up
```
